#!/usr/bin/env python3
import os, json
from datetime import datetime
from openai import OpenAI

client = OpenAI(api_key=os.getenv("OPENAI_API_KEY"))


# ============================================================
# UTILITIES
# ============================================================

def load_prompt(filename):
    """Load a prompt file from prompts/phase0/ directory."""
    script_dir = os.path.dirname(os.path.abspath(__file__))
    prompts_dir = os.path.join(os.path.dirname(script_dir), "prompts", "phase0")
    prompt_path = os.path.join(prompts_dir, filename)
    with open(prompt_path, "r", encoding="utf-8") as f:
        return f.read().strip()


def multiline_input(prompt="Enter text. Type END alone on a line to finish:"):
    print(prompt)
    lines = []
    while True:
        line = input()
        if line.strip() == "END":
            break
        lines.append(line)
    text = "\n".join(lines).strip()
    return text if text else None


def save_json(path, payload):
    os.makedirs(os.path.dirname(path), exist_ok=True)
    with open(path, "w") as f:
        json.dump(payload, f, indent=2)


def llm(system, user, *, json_output=False):
    if json_output:
        resp = client.chat.completions.create(
            model="gpt-4.1-mini",
            messages=[
                {"role": "system", "content": system},
                {"role": "user", "content": user}
            ],
            response_format={"type": "json_object"}
        )
        return json.loads(resp.choices[0].message.content)

    resp = client.chat.completions.create(
        model="gpt-4.1-mini",
        messages=[
            {"role": "system", "content": system},
            {"role": "user", "content": user}
        ]
    )
    return resp.choices[0].message.content.strip()


# ============================================================
# AGENTS
# ============================================================

# -------------------------
# INITIAL SCRIPT GENERATION
# -------------------------
def generate_initial_script(ad_concept):
    system_prompt = load_prompt("generate_initial_script.txt")
    return llm(system_prompt, ad_concept)


# -------------------------
# CRITIQUE AGENT
# -------------------------
def critique_script(script, human_feedback=None):
    human_feedback = human_feedback or "None"
    system_prompt = load_prompt("critique_script.txt")

    user_prompt = f"""
SCRIPT:
{script}

HUMAN FEEDBACK (must override everything else):
{human_feedback}

Provide:
1. Issues (excluding anything the human has explicitly or implicitly allowed)
2. Improvements that DO NOT contradict human guidance
3. A 1–2 sentence creative north star
"""

    return llm(system_prompt, user_prompt)


# -------------------------
# REVISION AGENT
# -------------------------
def revise_script(script, critique, human_feedback=None):
    human_feedback = human_feedback or "None"
    system_prompt = load_prompt("revise_script.txt")

    user_prompt = f"""
ORIGINAL SCRIPT:
{script}

CRITIQUE:
{critique}

HUMAN FEEDBACK (overrides critique):
{human_feedback}

Revise accordingly.
"""

    return llm(system_prompt, user_prompt)


# -------------------------
# READINESS AGENT
# -------------------------
def check_readiness(script):
    system_prompt = load_prompt("check_readiness.txt")
    result = llm(system_prompt, script, json_output=True)
    return result["ready"], result["reason"]


# ============================================================
# MAIN ORCHESTRATOR
# ============================================================

def main():
    print("=== Phase 0 — Script Development Orchestrator ===")

    # -----------------------------
    # 1. Get ad concept from user
    # -----------------------------
    concept = multiline_input(
        "Describe your ad concept.\nType freely. Finish with END:"
    )

    # -----------------------------
    # 2. Generate first draft
    # -----------------------------
    script = generate_initial_script(concept)
    print("\n=== INITIAL SCRIPT ===\n")
    print(script)

    iteration = 1
    human_feedback = None

    # -----------------------------
    # MAIN LOOP
    # -----------------------------
    while True:
        print(f"\n=== ITERATION {iteration}: CRITIQUE ===\n")

        critique = critique_script(script, human_feedback)
        print(critique)

        timestamp = datetime.now().strftime("%Y%m%d_%H%M%S")
        save_json(f"artifacts/phase0/critique_{timestamp}.json", {"critique": critique})
        save_json(f"artifacts/phase0/script_{timestamp}.json", {"script": script})

        print("\nProvide human feedback for next revision.")
        print("Type your notes. Finish with END. Press ENTER then END for none.\n")

        human_feedback = multiline_input()

        # -----------------------------
        # 3. Revise using critique + human
        # -----------------------------
        print("\nRevising script...\n")
        script = revise_script(script, critique, human_feedback)

        print("\n=== UPDATED SCRIPT ===\n")
        print(script)

        # -----------------------------
        # 4. Readiness check
        # -----------------------------
        ready, reason = check_readiness(script)
        print("\nReadiness Check:", ready, "-", reason)

        if ready:
            confirm = input("\nLLM says it's ready. Are YOU satisfied? (y/n) ").lower()
            if confirm.startswith("y"):
                os.makedirs("artifacts/phase0", exist_ok=True)
                with open("artifacts/phase0/final_script.txt", "w") as f:
                    f.write(script)
                print("\nFinal script saved.")
                break

        iteration += 1


# ============================================================
# ENTRY POINT
# ============================================================
if __name__ == "__main__":
    main()

