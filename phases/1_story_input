#!/usr/bin/env python3
import os, json, sys
from datetime import datetime
from openai import OpenAI

client = OpenAI(api_key=os.getenv("OPENAI_API_KEY"))


# ============================================================
# UTILITIES
# ============================================================


def load_prompt(filename):
    """Load a prompt file from prompts/1_story_input/ directory."""
    script_dir = os.path.dirname(os.path.abspath(__file__))
    prompts_dir = os.path.join(os.path.dirname(script_dir), "prompts", "1_story_input")
    prompt_path = os.path.join(prompts_dir, filename)
    with open(prompt_path, "r", encoding="utf-8") as f:
        return f.read().strip()


def multiline_input(prompt="Enter text. Type END to finish:"):
    print(prompt)
    lines = []
    while True:
        line = input()
        stripped = line.strip().upper()
        if stripped == "END":
            break
        if stripped == "APPROVED":
            return "APPROVED"
        lines.append(line)
    return "\n".join(lines).strip() or None


def save_json(path, payload):
    os.makedirs(os.path.dirname(path), exist_ok=True)
    with open(path, "w") as f:
        json.dump(payload, f, indent=2, ensure_ascii=False)


def llm(system, user, *, json_output=False):
    if json_output:
        resp = client.chat.completions.create(
            model="gpt-4.1-mini",
            messages=[
                {"role": "system", "content": system},
                {"role": "user", "content": user},
            ],
            response_format={"type": "json_object"},
            temperature=0.2,
        )
        return json.loads(resp.choices[0].message.content)

    resp = client.chat.completions.create(
        model="gpt-4.1-mini",
        messages=[
            {"role": "system", "content": system},
            {"role": "user", "content": user},
        ],
        temperature=0.2,
    )
    return resp.choices[0].message.content.strip()


# ============================================================
# AGENTS
# ============================================================


def generate_initial_script(ad_concept, duration_seconds):
    system_prompt = load_prompt("generate_initial_script.txt")

    user_block = json.dumps(
        {"concept": ad_concept, "duration_seconds": duration_seconds}
    )

    return llm(system_prompt, user_block)


def critique_script(script, duration_seconds, human_feedback=None):
    human_feedback = human_feedback or "None"
    system_prompt = load_prompt("critique_script.txt")

    user_prompt = f"""
SCRIPT:
{script}

REQUESTED_DURATION_SECONDS: {duration_seconds}

HUMAN_FEEDBACK (overrides all):
{human_feedback}
"""

    return llm(system_prompt, user_prompt)


def revise_script(script, critique, duration_seconds, human_feedback=None):
    human_feedback = human_feedback or "None"
    system_prompt = load_prompt("revise_script.txt")

    user_prompt = f"""
CURRENT_SCRIPT:
{script}

CRITIQUE:
{critique}

REQUESTED_DURATION_SECONDS: {duration_seconds}

HUMAN_FEEDBACK:
{human_feedback}

Revise accordingly.
"""
    return llm(system_prompt, user_prompt)


def check_readiness(script, duration_seconds):
    system_prompt = load_prompt("check_readiness.txt")
    user_prompt = json.dumps({"script": script, "duration_seconds": duration_seconds})

    result = llm(system_prompt, user_prompt, json_output=True)
    return result["ready"], result["reason"]


# ============================================================
# MAIN ORCHESTRATOR
# ============================================================


def main():
    print("=== Phase 1 — Script Development Orchestrator ===\n")

    # -----------------------------
    # Ask user for the ad duration
    # -----------------------------
    while True:
        raw = input("Desired ad duration in seconds (e.g., 15, 20, 30): ").strip()
        try:
            duration_seconds = int(raw)
            if duration_seconds <= 0:
                raise ValueError()
            break
        except:
            print("Invalid. Please enter a positive integer.\n")

    print(f"✓ Duration set to {duration_seconds} seconds.\n")

    # -----------------------------
    # Get ad concept
    # -----------------------------
    concept = multiline_input(
        "Describe your ad concept.\nType freely. Finish with END:"
    )

    if not concept:
        print("❌ No concept provided. Exiting.")
        sys.exit(1)

    print("✓ Concept received.\n")

    # -----------------------------
    # Generate initial script
    # -----------------------------
    script = generate_initial_script(concept, duration_seconds)

    print("\n=== INITIAL SCRIPT ===\n")
    print(script)

    iteration = 1
    human_feedback = None

    # -----------------------------
    # Iterative critique loop
    # -----------------------------
    while True:
        print(f"\n=== ITERATION {iteration}: CRITIQUE ===\n")

        critique = critique_script(script, duration_seconds, human_feedback)
        print(critique)

        timestamp = datetime.now().strftime("%Y%m%d_%H%M%S")
        save_json(
            f"artifacts/1_story_input/critique_{timestamp}.json",
            {"critique": critique, "duration_seconds": duration_seconds},
        )
        save_json(
            f"artifacts/1_story_input/script_{timestamp}.json",
            {"script": script, "duration_seconds": duration_seconds},
        )

        print("\nProvide human feedback (END to finish, APPROVE to finalize):")
        human_feedback = multiline_input()

        if human_feedback == "APPROVE":
            print("✓ Script approved.")
            os.makedirs("artifacts/1_story_input", exist_ok=True)
            save_json(
                "artifacts/1_story_input/final_script.json",
                {"script": script, "duration_seconds": duration_seconds},
            )
            print("✓ Final script saved.")
            break

        if human_feedback:
            print("\nRegenerating script with HUMAN FEEDBACK…\n")
        else:
            print("\nRegenerating script using critique only…\n")

        script = revise_script(script, critique, duration_seconds, human_feedback)

        print("\n=== UPDATED SCRIPT ===\n")
        print(script)

        # -----------------------------
        # Readiness check
        # -----------------------------
        ready, reason = check_readiness(script, duration_seconds)
        print("\nReadiness Check:", ready, "-", reason)

        if ready:
            confirm = (
                input("\nScript is ready. Do YOU approve? (y/n): ").strip().lower()
            )
            if confirm.startswith("y"):
                save_json(
                    "artifacts/1_story_input/final_script.json",
                    {"script": script, "duration_seconds": duration_seconds},
                )
                print("✓ Final script saved.")
                break
            print("Continuing revisions…\n")

        iteration += 1


if __name__ == "__main__":
    main()
