#!/usr/bin/env python3
import os, json, base64, replicate
from dotenv import load_dotenv

load_dotenv()
client = replicate.Client(api_token=os.getenv("REPLICATE_API_TOKEN"))

os.makedirs("scenes_mp4", exist_ok=True)

with open("scenes.json") as f:
    scenes = json.load(f)["scenes"]

for scene in scenes:
    scene_num = scene["scene_number"]
    keyframe_path = f"keyframes/scene_{scene_num}.webp"

    # Encode keyframe as base64 for MiniMax
    with open(keyframe_path, "rb") as f:
        b64 = base64.b64encode(f.read()).decode("utf-8")

    # MiniMax only accepts duration of 6 or 10 seconds
    scene_duration = scene["duration"]
    duration = 10 if scene_duration >= 8 else 6

    prompt = f"""
High-end cinematic motion consistent with the provided keyframe.

Scene description: {scene['description']}
Camera framing: {scene['camera'].get('framing')}
Camera movement: {scene['camera'].get('movement')}
Style: {scene.get('style')}

Maintain character identity, wardrobe, lighting, and watch design.
""".strip()

    print(f"\nAnimating scene {scene_num}...")

    output = client.run(
        "minimax/hailuo-02",
        input={
            "prompt": prompt,
            "duration": duration,                # seconds
            "resolution": "512p",                # cheaper for testing
            "first_frame_image": f"data:image/webp;base64,{b64}",
            "prompt_optimizer": False,           # disables rewriting
        }
    )

    # `output` is a FileOutput object
    video_bytes = output.read()
    final_path = f"scenes_mp4/scene_{scene_num}.mp4"

    with open(final_path, "wb") as f:
        f.write(video_bytes)

    print(f"Saved â†’ {final_path}")
